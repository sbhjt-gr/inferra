<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inferra WebRTC Client</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1E1326;
      color: #fff;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 20px;
      color: #9C38C0;
    }

    .status {
      background: #2A1F37;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #3D2D4A;
    }

    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .status-indicator.disconnected {
      background: #dc3545;
    }

    .status-indicator.connecting {
      background: #ffc107;
    }

    .status-indicator.connected {
      background: #28a745;
    }

    .section {
      background: #2A1F37;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #3D2D4A;
    }

    .section h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #BDB7C4;
    }

    textarea {
      width: 100%;
      min-height: 100px;
      background: #1E1326;
      border: 1px solid #3D2D4A;
      border-radius: 6px;
      padding: 12px;
      color: #fff;
      font-family: monospace;
      font-size: 12px;
      resize: vertical;
      margin-bottom: 10px;
    }

    button {
      background: #660880;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #9C38C0;
    }

    button:disabled {
      background: #3D2D4A;
      cursor: not-allowed;
    }

    .chat-input {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .chat-input input {
      flex: 1;
      background: #1E1326;
      border: 1px solid #3D2D4A;
      border-radius: 6px;
      padding: 12px;
      color: #fff;
      font-size: 14px;
    }

    .messages {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 15px;
    }

    .message {
      background: #1E1326;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 10px;
      border-left: 3px solid #660880;
    }

    .message.user {
      border-left-color: #9C38C0;
    }

    .message.assistant {
      border-left-color: #28a745;
    }

    .message-role {
      font-weight: 600;
      font-size: 12px;
      color: #BDB7C4;
      margin-bottom: 5px;
    }

    .message-content {
      font-size: 14px;
      line-height: 1.5;
    }

    .qr-code {
      text-align: center;
      padding: 20px;
      background: white;
      border-radius: 8px;
      margin: 20px 0;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Inferra WebRTC Client</h1>

    <div class="status">
      <span class="status-indicator disconnected" id="statusIndicator"></span>
      <span id="statusText">Disconnected</span>
    </div>

    <div class="section" id="setupSection">
      <h2>Step 1: Scan QR from App</h2>
      <textarea id="offerInput" placeholder="Paste offer SDP from app here..."></textarea>
      <button id="createAnswerBtn">Create Answer</button>

      <div id="answerSection" class="hidden">
        <h2>Step 2: Scan this QR in App</h2>
        <div class="qr-code">
          <canvas id="qrCanvas"></canvas>
        </div>
        <textarea id="answerOutput" readonly></textarea>
      </div>
    </div>

    <div class="section hidden" id="chatSection">
      <h2>Chat</h2>
      <div class="messages" id="messages"></div>
      <div class="chat-input">
        <input type="text" id="messageInput" placeholder="Type your message...">
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    class InferraWebRTCClient {
      constructor() {
        this.pc = null;
        this.dataChannel = null;
        this.isConnected = false;
        this.messageId = 0;
        this.pendingRequests = new Map();

        this.setupUI();
      }

      setupUI() {
        document.getElementById('createAnswerBtn').addEventListener('click', () => this.createAnswer());
        document.getElementById('sendBtn').addEventListener('click', () => this.sendMessage());
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') this.sendMessage();
        });
      }

      updateStatus(text, state) {
        document.getElementById('statusText').textContent = text;
        const indicator = document.getElementById('statusIndicator');
        indicator.className = `status-indicator ${state}`;
      }

      async createAnswer() {
        const offerSDP = document.getElementById('offerInput').value.trim();
        if (!offerSDP) {
          alert('Please paste the offer SDP');
          return;
        }

        try {
          this.updateStatus('Connecting...', 'connecting');

          this.pc = new RTCPeerConnection({
            iceServers: [
              { urls: 'stun:stun.l.google.com:19302' },
              { urls: 'stun:stun1.l.google.com:19302' }
            ]
          });

          this.pc.ondatachannel = (event) => {
            this.dataChannel = event.channel;
            this.setupDataChannel();
          };

          this.pc.oniceconnectionstatechange = () => {
            if (this.pc.iceConnectionState === 'connected') {
              this.isConnected = true;
              this.updateStatus('Connected', 'connected');
              document.getElementById('setupSection').classList.add('hidden');
              document.getElementById('chatSection').classList.remove('hidden');
            } else if (this.pc.iceConnectionState === 'failed' || this.pc.iceConnectionState === 'disconnected') {
              this.updateStatus('Disconnected', 'disconnected');
            }
          };

          await this.pc.setRemoteDescription({ type: 'offer', sdp: offerSDP });
          const answer = await this.pc.createAnswer();
          await this.pc.setLocalDescription(answer);

          document.getElementById('answerOutput').value = answer.sdp;
          document.getElementById('answerSection').classList.remove('hidden');

          new QRCode(document.getElementById('qrCanvas'), {
            text: answer.sdp,
            width: 256,
            height: 256
          });

        } catch (error) {
          this.updateStatus('Connection failed', 'disconnected');
          alert('Error: ' + error.message);
        }
      }

      setupDataChannel() {
        this.dataChannel.onopen = () => {
          console.log('data_channel_open');
        };

        this.dataChannel.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            if (data.id && this.pendingRequests.has(data.id)) {
              const callback = this.pendingRequests.get(data.id);
              callback(data);
              this.pendingRequests.delete(data.id);
            }
          } catch (error) {
            console.error('message_parse_error', error);
          }
        };

        this.dataChannel.onerror = (error) => {
          console.error('data_channel_error', error);
        };
      }

      sendAPIRequest(endpoint, data) {
        return new Promise((resolve) => {
          if (!this.dataChannel || this.dataChannel.readyState !== 'open') {
            resolve({ success: false, error: 'not_connected' });
            return;
          }

          const id = `msg_${++this.messageId}`;
          this.pendingRequests.set(id, resolve);

          this.dataChannel.send(JSON.stringify({
            id,
            endpoint,
            data
          }));

          setTimeout(() => {
            if (this.pendingRequests.has(id)) {
              this.pendingRequests.delete(id);
              resolve({ success: false, error: 'timeout' });
            }
          }, 30000);
        });
      }

      async sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        if (!message) return;

        this.addMessage('user', message);
        input.value = '';

        try {
          const response = await this.sendAPIRequest('/api/chat', {
            messages: [
              { role: 'user', content: message }
            ]
          });

          if (response.success && response.data) {
            this.addMessage('assistant', response.data.response);
          } else {
            this.addMessage('assistant', 'Error: ' + (response.error || 'unknown_error'));
          }
        } catch (error) {
          this.addMessage('assistant', 'Error: ' + error.message);
        }
      }

      addMessage(role, content) {
        const messagesDiv = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        messageDiv.innerHTML = `
          <div class="message-role">${role.toUpperCase()}</div>
          <div class="message-content">${content}</div>
        `;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    }

    const client = new InferraWebRTCClient();
  </script>
</body>
</html>
